var n$1,l,u,t$1,o,f={},e$1=[],c=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i;function s(n,l){for(var u in l)n[u]=l[u];return n}function a(n){var l=n.parentNode;l&&l.removeChild(n);}function h(l,u,i){var t,o,r,f={};for(r in u)"key"==r?t=u[r]:"ref"==r?o=u[r]:f[r]=u[r];if(arguments.length>2&&(f.children=arguments.length>3?n$1.call(arguments,2):i),"function"==typeof l&&null!=l.defaultProps)for(r in l.defaultProps)void 0===f[r]&&(f[r]=l.defaultProps[r]);return v(l,f,t,o,null)}function v(n,i,t,o,r){var f={type:n,props:i,key:t,ref:o,__k:null,__:null,__b:0,__e:null,__d:void 0,__c:null,__h:null,constructor:void 0,__v:null==r?++u:r};return null==r&&null!=l.vnode&&l.vnode(f),f}function p(n){return n.children}function d(n,l){this.props=n,this.context=l;}function _(n,l){if(null==l)return n.__?_(n.__,n.__.__k.indexOf(n)+1):null;for(var u;l<n.__k.length;l++)if(null!=(u=n.__k[l])&&null!=u.__e)return u.__e;return "function"==typeof n.type?_(n):null}function k(n){var l,u;if(null!=(n=n.__)&&null!=n.__c){for(n.__e=n.__c.base=null,l=0;l<n.__k.length;l++)if(null!=(u=n.__k[l])&&null!=u.__e){n.__e=n.__c.base=u.__e;break}return k(n)}}function b(n){(!n.__d&&(n.__d=!0)&&t$1.push(n)&&!g.__r++||o!==l.debounceRendering)&&((o=l.debounceRendering)||setTimeout)(g);}function g(){for(var n;g.__r=t$1.length;)n=t$1.sort(function(n,l){return n.__v.__b-l.__v.__b}),t$1=[],n.some(function(n){var l,u,i,t,o,r;n.__d&&(o=(t=(l=n).__v).__e,(r=l.__P)&&(u=[],(i=s({},t)).__v=t.__v+1,j(r,t,i,l.__n,void 0!==r.ownerSVGElement,null!=t.__h?[o]:null,u,null==o?_(t):o,t.__h),z(u,t),t.__e!=o&&k(t)));});}function w(n,l,u,i,t,o,r,c,s,a){var h,y,d,k,b,g,w,x=i&&i.__k||e$1,C=x.length;for(u.__k=[],h=0;h<l.length;h++)if(null!=(k=u.__k[h]=null==(k=l[h])||"boolean"==typeof k?null:"string"==typeof k||"number"==typeof k||"bigint"==typeof k?v(null,k,null,null,k):Array.isArray(k)?v(p,{children:k},null,null,null):k.__b>0?v(k.type,k.props,k.key,null,k.__v):k)){if(k.__=u,k.__b=u.__b+1,null===(d=x[h])||d&&k.key==d.key&&k.type===d.type)x[h]=void 0;else for(y=0;y<C;y++){if((d=x[y])&&k.key==d.key&&k.type===d.type){x[y]=void 0;break}d=null;}j(n,k,d=d||f,t,o,r,c,s,a),b=k.__e,(y=k.ref)&&d.ref!=y&&(w||(w=[]),d.ref&&w.push(d.ref,null,k),w.push(y,k.__c||b,k)),null!=b?(null==g&&(g=b),"function"==typeof k.type&&k.__k===d.__k?k.__d=s=m$1(k,s,n):s=A(n,k,d,x,b,s),"function"==typeof u.type&&(u.__d=s)):s&&d.__e==s&&s.parentNode!=n&&(s=_(d));}for(u.__e=g,h=C;h--;)null!=x[h]&&("function"==typeof u.type&&null!=x[h].__e&&x[h].__e==u.__d&&(u.__d=_(i,h+1)),N(x[h],x[h]));if(w)for(h=0;h<w.length;h++)M(w[h],w[++h],w[++h]);}function m$1(n,l,u){for(var i,t=n.__k,o=0;t&&o<t.length;o++)(i=t[o])&&(i.__=n,l="function"==typeof i.type?m$1(i,l,u):A(u,i,i,t,i.__e,l));return l}function A(n,l,u,i,t,o){var r,f,e;if(void 0!==l.__d)r=l.__d,l.__d=void 0;else if(null==u||t!=o||null==t.parentNode)n:if(null==o||o.parentNode!==n)n.appendChild(t),r=null;else {for(f=o,e=0;(f=f.nextSibling)&&e<i.length;e+=2)if(f==t)break n;n.insertBefore(t,o),r=o;}return void 0!==r?r:t.nextSibling}function C(n,l,u,i,t){var o;for(o in u)"children"===o||"key"===o||o in l||H(n,o,null,u[o],i);for(o in l)t&&"function"!=typeof l[o]||"children"===o||"key"===o||"value"===o||"checked"===o||u[o]===l[o]||H(n,o,l[o],u[o],i);}function $(n,l,u){"-"===l[0]?n.setProperty(l,u):n[l]=null==u?"":"number"!=typeof u||c.test(l)?u:u+"px";}function H(n,l,u,i,t){var o;n:if("style"===l)if("string"==typeof u)n.style.cssText=u;else {if("string"==typeof i&&(n.style.cssText=i=""),i)for(l in i)u&&l in u||$(n.style,l,"");if(u)for(l in u)i&&u[l]===i[l]||$(n.style,l,u[l]);}else if("o"===l[0]&&"n"===l[1])o=l!==(l=l.replace(/Capture$/,"")),l=l.toLowerCase()in n?l.toLowerCase().slice(2):l.slice(2),n.l||(n.l={}),n.l[l+o]=u,u?i||n.addEventListener(l,o?T:I,o):n.removeEventListener(l,o?T:I,o);else if("dangerouslySetInnerHTML"!==l){if(t)l=l.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if("href"!==l&&"list"!==l&&"form"!==l&&"tabIndex"!==l&&"download"!==l&&l in n)try{n[l]=null==u?"":u;break n}catch(n){}"function"==typeof u||(null!=u&&(!1!==u||"a"===l[0]&&"r"===l[1])?n.setAttribute(l,u):n.removeAttribute(l));}}function I(n){this.l[n.type+!1](l.event?l.event(n):n);}function T(n){this.l[n.type+!0](l.event?l.event(n):n);}function j(n,u,i,t,o,r,f,e,c){var a,h,v,y,_,k,b,g,m,x,A,C,$,H=u.type;if(void 0!==u.constructor)return null;null!=i.__h&&(c=i.__h,e=u.__e=i.__e,u.__h=null,r=[e]),(a=l.__b)&&a(u);try{n:if("function"==typeof H){if(g=u.props,m=(a=H.contextType)&&t[a.__c],x=a?m?m.props.value:a.__:t,i.__c?b=(h=u.__c=i.__c).__=h.__E:("prototype"in H&&H.prototype.render?u.__c=h=new H(g,x):(u.__c=h=new d(g,x),h.constructor=H,h.render=O),m&&m.sub(h),h.props=g,h.state||(h.state={}),h.context=x,h.__n=t,v=h.__d=!0,h.__h=[]),null==h.__s&&(h.__s=h.state),null!=H.getDerivedStateFromProps&&(h.__s==h.state&&(h.__s=s({},h.__s)),s(h.__s,H.getDerivedStateFromProps(g,h.__s))),y=h.props,_=h.state,v)null==H.getDerivedStateFromProps&&null!=h.componentWillMount&&h.componentWillMount(),null!=h.componentDidMount&&h.__h.push(h.componentDidMount);else {if(null==H.getDerivedStateFromProps&&g!==y&&null!=h.componentWillReceiveProps&&h.componentWillReceiveProps(g,x),!h.__e&&null!=h.shouldComponentUpdate&&!1===h.shouldComponentUpdate(g,h.__s,x)||u.__v===i.__v){h.props=g,h.state=h.__s,u.__v!==i.__v&&(h.__d=!1),h.__v=u,u.__e=i.__e,u.__k=i.__k,u.__k.forEach(function(n){n&&(n.__=u);}),h.__h.length&&f.push(h);break n}null!=h.componentWillUpdate&&h.componentWillUpdate(g,h.__s,x),null!=h.componentDidUpdate&&h.__h.push(function(){h.componentDidUpdate(y,_,k);});}if(h.context=x,h.props=g,h.__v=u,h.__P=n,A=l.__r,C=0,"prototype"in H&&H.prototype.render)h.state=h.__s,h.__d=!1,A&&A(u),a=h.render(h.props,h.state,h.context);else do{h.__d=!1,A&&A(u),a=h.render(h.props,h.state,h.context),h.state=h.__s;}while(h.__d&&++C<25);h.state=h.__s,null!=h.getChildContext&&(t=s(s({},t),h.getChildContext())),v||null==h.getSnapshotBeforeUpdate||(k=h.getSnapshotBeforeUpdate(y,_)),$=null!=a&&a.type===p&&null==a.key?a.props.children:a,w(n,Array.isArray($)?$:[$],u,i,t,o,r,f,e,c),h.base=u.__e,u.__h=null,h.__h.length&&f.push(h),b&&(h.__E=h.__=null),h.__e=!1;}else null==r&&u.__v===i.__v?(u.__k=i.__k,u.__e=i.__e):u.__e=L(i.__e,u,i,t,o,r,f,c);(a=l.diffed)&&a(u);}catch(n){u.__v=null,(c||null!=r)&&(u.__e=e,u.__h=!!c,r[r.indexOf(e)]=null),l.__e(n,u,i);}}function z(n,u){l.__c&&l.__c(u,n),n.some(function(u){try{n=u.__h,u.__h=[],n.some(function(n){n.call(u);});}catch(n){l.__e(n,u.__v);}});}function L(l,u,i,t,o,r,e,c){var s,h,v,y=i.props,p=u.props,d=u.type,k=0;if("svg"===d&&(o=!0),null!=r)for(;k<r.length;k++)if((s=r[k])&&"setAttribute"in s==!!d&&(d?s.localName===d:3===s.nodeType)){l=s,r[k]=null;break}if(null==l){if(null===d)return document.createTextNode(p);l=o?document.createElementNS("http://www.w3.org/2000/svg",d):document.createElement(d,p.is&&p),r=null,c=!1;}if(null===d)y===p||c&&l.data===p||(l.data=p);else {if(r=r&&n$1.call(l.childNodes),h=(y=i.props||f).dangerouslySetInnerHTML,v=p.dangerouslySetInnerHTML,!c){if(null!=r)for(y={},k=0;k<l.attributes.length;k++)y[l.attributes[k].name]=l.attributes[k].value;(v||h)&&(v&&(h&&v.__html==h.__html||v.__html===l.innerHTML)||(l.innerHTML=v&&v.__html||""));}if(C(l,p,y,o,c),v)u.__k=[];else if(k=u.props.children,w(l,Array.isArray(k)?k:[k],u,i,t,o&&"foreignObject"!==d,r,e,r?r[0]:i.__k&&_(i,0),c),null!=r)for(k=r.length;k--;)null!=r[k]&&a(r[k]);c||("value"in p&&void 0!==(k=p.value)&&(k!==l.value||"progress"===d&&!k||"option"===d&&k!==y.value)&&H(l,"value",k,y.value,!1),"checked"in p&&void 0!==(k=p.checked)&&k!==l.checked&&H(l,"checked",k,y.checked,!1));}return l}function M(n,u,i){try{"function"==typeof n?n(u):n.current=u;}catch(n){l.__e(n,i);}}function N(n,u,i){var t,o;if(l.unmount&&l.unmount(n),(t=n.ref)&&(t.current&&t.current!==n.__e||M(t,null,u)),null!=(t=n.__c)){if(t.componentWillUnmount)try{t.componentWillUnmount();}catch(n){l.__e(n,u);}t.base=t.__P=null;}if(t=n.__k)for(o=0;o<t.length;o++)t[o]&&N(t[o],u,"function"!=typeof n.type);i||null==n.__e||a(n.__e),n.__e=n.__d=void 0;}function O(n,l,u){return this.constructor(n,u)}function P(u,i,t){var o,r,e;l.__&&l.__(u,i),r=(o="function"==typeof t)?null:t&&t.__k||i.__k,e=[],j(i,u=(!o&&t||i).__k=h(p,null,[u]),r||f,f,void 0!==i.ownerSVGElement,!o&&t?[t]:r?null:i.firstChild?n$1.call(i.childNodes):null,e,!o&&t?t:r?r.__e:i.firstChild,o),z(e,u);}n$1=e$1.slice,l={__e:function(n,l,u,i){for(var t,o,r;l=l.__;)if((t=l.__c)&&!t.__)try{if((o=t.constructor)&&null!=o.getDerivedStateFromError&&(t.setState(o.getDerivedStateFromError(n)),r=t.__d),null!=t.componentDidCatch&&(t.componentDidCatch(n,i||{}),r=t.__d),r)return t.__E=t}catch(l){n=l;}throw n}},u=0,d.prototype.setState=function(n,l){var u;u=null!=this.__s&&this.__s!==this.state?this.__s:this.__s=s({},this.state),"function"==typeof n&&(n=n(s({},u),this.props)),n&&s(u,n),null!=n&&this.__v&&(l&&this.__h.push(l),b(this));},d.prototype.forceUpdate=function(n){this.__v&&(this.__e=!0,n&&this.__h.push(n),b(this));},d.prototype.render=p,t$1=[],g.__r=0;

var n=function(t,s,r,e){var u;s[0]=0;for(var h=1;h<s.length;h++){var p=s[h++],a=s[h]?(s[0]|=p?1:2,r[s[h++]]):s[++h];3===p?e[0]=a:4===p?e[1]=Object.assign(e[1]||{},a):5===p?(e[1]=e[1]||{})[s[++h]]=a:6===p?e[1][s[++h]]+=a+"":p?(u=t.apply(a,n(t,a,r,["",null])),e.push(u),a[0]?s[0]|=2:(s[h-2]=0,s[h]=u)):e.push(a);}return e},t=new Map;function e(s){var r=t.get(this);return r||(r=new Map,t.set(this,r)),(r=n(this,r.get(s)||(r.set(s,r=function(n){for(var t,s,r=1,e="",u="",h=[0],p=function(n){1===r&&(n||(e=e.replace(/^\s*\n\s*|\s*\n\s*$/g,"")))?h.push(0,n,e):3===r&&(n||e)?(h.push(3,n,e),r=2):2===r&&"..."===e&&n?h.push(4,n,0):2===r&&e&&!n?h.push(5,0,!0,e):r>=5&&((e||!n&&5===r)&&(h.push(r,0,e,s),r=6),n&&(h.push(r,n,0,s),r=6)),e="";},a=0;a<n.length;a++){a&&(1===r&&p(),p(a));for(var l=0;l<n[a].length;l++)t=n[a][l],1===r?"<"===t?(p(),h=[h],r=3):e+=t:4===r?"--"===e&&">"===t?(r=1,e=""):e=t+e[0]:u?t===u?u="":e+=t:'"'===t||"'"===t?u=t:">"===t?(p(),r=1):r&&("="===t?(r=5,s=e,e=""):"/"===t&&(r<5||">"===n[a][l+1])?(p(),3===r&&(h=h[0]),r=h,(h=h[0]).push(2,0,r),r=0):" "===t||"\t"===t||"\n"===t||"\r"===t?(p(),r=2):e+=t),3===r&&"!--"===e&&(r=4,h=h[0]);}return p(),h}(s)),r),arguments,[])).length>1?r:r[0]}

var m=e.bind(h);

const UI_TRANSLATIONS = {
    /* Add languages here */
    en: {
        /* Add translations here */
        DIAGNOSTICS: "Diagnostics",
        HELP_URL: "https://rdmr.eu/link-beoordeelaar/help/enduser/en",
        LANGUAGE: "English",
        CORRECT: "Correct",
        INCORRECT: "Incorrect",
        APP_TITLE: "Categorize",
        FINAL_TITLE: "Ready to send in",
        START: "Start",
        START_DESC: "Commence categorizing links",
        REOPEN_POPUP: "Reopen popup window",
        INTRODUCTION: `Categorize the link that has opened in the popup window
      by choosing one of the following options. If you need to pause, you may
      resume categorizing within one week inside this very browser.`,
        INTRODUCTION_SESSIONLESS: `Provide a session key that refers to the
      questionnaire you want filled out.`,
        INTRODUCTION_OPENING: `Categorize the links that open in a popup window, by
      choosing one of the provided options. Select START to begin.`,
        CLOSING_REMARKS_MAIL: `Thank you for participating. Copy and send your
      results displayed below to the e-mail address displayed below that. 
      Otherwise, your response may not be recorded.`,
    },
    nl: {
        DIAGNOSTICS: "Diagnostica",
        HELP_URL: "https://rdmr.eu/link-beoordeelaar/help/enduser/nl",
        LANGUAGE: "Nederlands",
        CORRECT: "Correct",
        INCORRECT: "Incorrect",
        APP_TITLE: "Beoordeel",
        FINAL_TITLE: "Klaar om in te sturen",
        START: "Start",
        START_DESC: "Begin met beoordelen van links",
        REOPEN_POPUP: "Heropen popupvenster",
        INTRODUCTION: `Beoordeel de link geopend in de popup door op een van de
      opties te klikken. Als je het beoordelen moet onderbreken, kun je op deze
      computer in deze browser binnen een week doorgaan. `,
        INTRODUCTION_SESSIONLESS: `Open deze pagina met een sessiesleutel die
      verwijst naar de lijst van links die moeten worden beoordeeld.`,
        INTRODUCTION_OPENING: `Beoordeel de links die openen in een popup door op een
      van de opties te klikken. Druk op START om te beginnen.`,
        CLOSING_REMARKS_MAIL: `Bedankt voor het meedoen. Kopieer de resultaten die 
      hieronder staan en stuur ze naar het e-mailadres dat daar onder
      staat. Anders worden je resultaten niet meegenomen.`,
    },
};
/** Document interface or User interface preferred language */
function prefLangs() {
    return [document.body.lang || "en"];
}
/**
 * Localized label.
 *
 * @param key The lookup key
 * @returns The translated label, or the untranslated key if not found.
 */
function label(key) {
    for (const l of prefLangs()) {
        if (UI_TRANSLATIONS.hasOwnProperty(l) &&
            UI_TRANSLATIONS[l].hasOwnProperty(key))
            return UI_TRANSLATIONS[l][key];
    }
    console.warn(`Translation for "${key}" not found`);
    return key;
}

class PropertiesTable extends d {
    render(props, state) {
        return m `
      <dl class="subject-properties measure-wide">
        ${Object.entries(props.subject).map(([key, rawvalue]) => {
            // If there are allowed-keys, then skip if key is in them
            if (props.keys.length > 0 && props.keys.indexOf(key) == -1)
                return m ``;
            // If the value is None, N/A, etc., skip
            if (["", undefined, null].indexOf(rawvalue) != -1)
                return m ``;
            const value = String(rawvalue);
            return m `
            <div class="keep-together kv-pair">
              <dt scope="row">${key}</dt>
              <dd><code>${value}</code></dd>
            </div>
          `;
        })}
      </dl>
    `;
    }
}
PropertiesTable.defaultProps = {
    subject: [],
    keys: [],
};
class AnswerOption extends d {
    keyboardSelect(event) {
        event.preventDefault();
        console.log(`keyboard select`);
    }
    mnemonic(index) {
        return [
            "f",
            "j",
            "x",
            "5",
            "6",
            "7",
            "d",
            "k",
            "r",
            "u",
            "e",
            "i",
            "1",
            "2",
            "9",
            "0",
        ][index];
    }
    render(props, state) {
        const answers = props.options;
        return m `
      <div class="option-list">
        ${answers.map((answer, n) => {
            return m `<${AnswerOptionButton}
            value=${answer.value}
            name=${answer.name}
            description=${answer.description}
            mnemonic=${this.mnemonic(n)}
          />`;
        })}
      </div>
    `;
    }
}
AnswerOption.defaultProps = {
    options: [],
};
function AnswerOptionButton(props) {
    return m `<button
    type="submit"
    class="option"
    id="opt-${props.value}"
    value=${props.value}
    data-key-equivalent=${props.mnemonic}
  >
    <span class="mnemonic"
      ><kbd title="press with keyboard">${props.mnemonic}</kbd></span
    >
    <h2 class="option-title">${props.name}</h2>
    <p class="option-description">${props.description}</p>
  </button>`;
}
class QuestionnairePage extends d {
    render(props, state) {
        return m `<div class="page">
      <${PageHeader$1}
        title="${label("APP_TITLE")}"
        desc="${label("INTRODUCTION")}"
        index=${props.index}
        max=${props.max}
        onClick=${props.onClick}
      />
      <main class="options-container">
        <form onSubmit=${props.onSubmit}>
          <${AnswerOption} options=${props.answerOptions} />
        </form>
      </main>
      <footer>
        <${PropertiesTable} subject=${props.subject} />
      </footer>
    </div> `;
    }
}
class QuestionnaireFinalPage extends d {
    render(props) {
        return m `<div class="page">
      <${PageHeader$1}
        title="${label("FINAL_TITLE")}"
        desc="${props.closingText ?? label("CLOSING_REMARKS_MAIL")}"
      />
      <main class="measure">
        <textarea rows="20" cols="60" readonly>${props.reportBody}</textarea>
        <div class="mailto-cta">
          <a
            target="_blank"
            href="mailto:${props.reportEmail}?subject=Linkbeoordeelaar"
            >${props.reportEmail}</a
          >
        </div>
      </main>
    </div>`;
    }
}
class QuestionnaireOpeningPage extends d {
    render(props) {
        return m `<div class="page">
      <${PageHeader$1}
        title="${label("APP_TITLE")}"
        desc="${label("INTRODUCTION_OPENING")}"
      />
      <main class="measure">
        <form onSubmit=${props.onSubmit}>
          <${AnswerOptionButton}
            value="start"
            mnemonic="Enter"
            name=${label("START")}
            description=${label("START_DESC")}
          />
        </form>
      </main>
    </div>`;
    }
}
class QuestionnaireSessionlessPage extends d {
    render() {
        return m `<div class="page">
      <${PageHeader$1}
        title="${label("APP_TITLE")}"
        desc="${label("INTRODUCTION_SESSIONLESS")}"
      />
    </div>`;
    }
}
const PageHeader$1 = (props) => {
    console.info(props);
    return m `<header class="measure">
    <h1>${props.title}</h1>
    <${Progress} index="${props.index}" max="${props.max}" />
    <p>
      ${props.desc}
      ${props.onClick
        ? m `<button onClick=${props.onClick}>
            ${label("REOPEN_POPUP")}
          </button>`
        : ""}
    </p>
  </header>`;
};
const Progress = (props) => {
    if (!props.max)
        return m ``;
    const percentage = props.index / props.max;
    return m `
    <h4>
      <progress id="voortgang" value="${props.index}" max="${props.max}">
        ${percentage.toFixed(0)}%
      </progress>
      <label for="voortgang">${props.index} / ${props.max}</label>
    </h4>
  `;
};

/**
 * Delay execution by milliseconds. Awaitable.
 *
 * @param ms Timeout in milliseconds.
 */
function delay(ms) {
    return new Promise((res) => setTimeout(res, ms));
}

class Configuration {
    static configurationURL(fromSessionKey) {
        return atob(fromSessionKey);
    }
    static sessionKeyForURL(url) {
        return btoa(url).replace("=", "");
    }
    static async fetchQuestionnaire(sessionKey, options) {
        const { cache } = { cache: true, ...options };
        const url = this.configurationURL(sessionKey);
        const response = await fetch(url, {
            redirect: "follow",
            cache: cache ? "default" : "no-cache",
        });
        const parsedConfig = await response.json();
        if (!this.isQuestionnaireValid(parsedConfig)) {
            throw new Error("Schema validation errors. Check session key payload.");
        }
        return { ...this.questionnaireDefaults(), ...parsedConfig };
    }
    static isQuestionnaireValid(data) {
        return data.hasOwnProperty("subjects") && data.hasOwnProperty("reporting");
    }
    static questionnaireDefaults() {
        return {
            lang: "en",
            help: label("HELP_URL"),
            keys: [],
            introductionText: label("INTRODUCTION"),
            closingText: label("CLOSING_REMARKS_MAIL"),
        };
    }
}

/// <reference path="../types/configuration.d.ts" />
class QuestionnaireApp extends d {
    constructor() {
        super(...arguments);
        this.navBack = async (event) => {
            this.state.answers.pop();
            this.setState({ answers: this.state.answers });
            window.localStorage.setItem(this.state.sessionKey, JSON.stringify(this.state.answers));
        };
        this.chooseOption = async (event) => {
            event.preventDefault();
            console.log(`Fire -chooseOption by ${event.submitter.value}`);
            const newAnswersValue = [
                ...this.state.answers,
                {
                    name: event.submitter.value,
                    value: event.submitter.value,
                },
            ];
            this.setState({ answers: newAnswersValue });
            history.pushState({ answers: newAnswersValue }, "");
            window.localStorage.setItem(this.state.sessionKey, JSON.stringify(newAnswersValue));
            // answers.length + 1 => state first updated at next rendering cycle
            try {
                this.popup.location =
                    this.state.data.subjects[this.state.answers.length + 1].url;
            }
            catch { }
        };
        this.start = async (event) => {
            event.preventDefault();
            this.popup = window.open(this.state.data.subjects[this.state.answers.length].url, // always at start
            this.POPUP_WINDOW, "toolbar=no,menubar=no,left=1,top=1");
            this.setState({ started: true });
        };
        this.POPUP_WINDOW = "link-beoordelaar-popup";
        this.answersBody = () => {
            let subjects = this.state.data.subjects;
            const zipped = subjects.map((s, i) => [s, this.state.answers[i]]);
            return zipped.reduce((body, [subject, answer]) => {
                const s = `${subject.url}`;
                const a = `${answer.value}`;
                return (body += `"${s}"\t"${a}"\n`);
            }, "Results\n\n");
        };
    }
    async componentDidMount() {
        const params = new URLSearchParams(window.location.search);
        const sessionKey = params.get("session");
        if (!sessionKey) {
            console.error("No session URL provided");
            return;
        }
        const data = await Configuration.fetchQuestionnaire(sessionKey);
        document.body.lang = data.lang;
        this.setState({
            sessionKey: sessionKey,
            data: data,
            answers: [],
            started: false,
        });
        document.addEventListener("keyup", this.findMnemonic);
        const savedValue = window.localStorage.getItem(sessionKey);
        if (savedValue) {
            this.setState({
                answers: JSON.parse(savedValue),
                started: true,
            });
        }
        window.addEventListener("popstate", this.navBack);
    }
    async findMnemonic(event) {
        event.preventDefault();
        console.log(`Keyboard pressed: ${event.key}`);
        /** @type {HTMLButtonElement | null} */
        const target = document.querySelector(`button[data-key-equivalent="${event.key}"]`);
        if (!target)
            return;
        target.classList.add("option-active");
        target.click();
        await delay(300);
        target.classList.remove("option-active");
    }
    render(props, state) {
        console.info(state);
        if (!state.data) {
            return m `<${QuestionnaireSessionlessPage} />`;
        }
        if (!state.started) {
            return m `<${QuestionnaireOpeningPage} onSubmit=${this.start} />`;
        }
        if (state.answers?.length == state.data.subjects?.length) {
            const body = this.answersBody();
            return m `<${QuestionnaireFinalPage}
        closingText=${state.data.closingText}
        reportEmail=${state.data.reporting.email ?? state.data.reporting}
        reportBody=${body}
      />`;
        }
        // Render the current subject
        return m `<${QuestionnairePage}
      onClick=${this.start}
      onSubmit=${this.chooseOption}
      answerOptions=${state.data.answerOptions}
      subject=${state.data.subjects[state.answers.length]}
      index=${state.answers.length + 1}
      max=${state.data.subjects.length}
    />`;
    }
}

class Frame extends d {
    constructor(props) {
        super(props);
        this.state = { hasError: false };
    }
    /** @param {Error} error */
    static getDerivedStateFromError(error) {
        console.log("called -getDerivedStateFromError");
        return {
            hasError: true,
            errorCode: error.name,
            errorMessage: error.message,
            error: error,
        };
    }
    render(props, state) {
        const repo = `redmer/link-beoordeelaar`;
        const help = props.config?.help ?? "https://rdmr.eu/link-beoordeelaar/help/enduser/nl";
        if (state.hasError) {
            return m `<div id="link-beoordelaar">
        <${PageHeader} repo=${repo} help=${help} />
        <main class="app">
          <header class="measure">
            <h1>Error</h1>
            <h2>${state.errorCode}</h2>
            <p>${state.errorMessage}</p>
          </header>
        </main>
        <${PageFooter} diagnostics=${state.error} />
      </div>`;
        }
        return m `<div id="link-beoordelaar">
      <${PageHeader} repo=${repo} help=${help} />
      <main class="app">${this.props.children}</main>
      <${PageFooter} />
    </div>`;
    }
}
function PageHeader(props) {
    return m `<header class="colophon">
    <div>
      <a target="_blank" href="https://github.com/${props.repo}">
        ${props.repo}
      </a>
    </div>
    <div>
      <a target="_blank" href=${props.help}>HELP</a>
    </div>
  </header>`;
}
function PageFooter(props) {
    return m `
    <footer class="diagnostics">
      <details closed>
        <summary>Diagnostica</summary>
        <code id="debug-diagnostics">${JSON.stringify(props.diagnostics)}</code>
      </details>
    </footer>
  `;
}

P(m `<${Frame}><${QuestionnaireApp} /></${Frame}>`, document.body);
